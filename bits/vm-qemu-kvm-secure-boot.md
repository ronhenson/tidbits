---
title: "Vm Qemu Kvm Secure Boot"
created: 2021-09-26 12:45:49
tags: devops
keywords: secure boot, qemu, kvm, uefi, gpt, mbr, keys
---

# Vm Qemu Kvm Secure Boot

## Windows 10 & 11 change from **mbr** to **gpt**

- Open powershell / cmd as administrator
- Check if mbr

```powershell
mbr2gpt /validate /allowPullOS
```

- convert to gtp

```powershell
mbr2gpt \convert \allowPullOS
```

## Using UEFI firmware from Fedora/Redhat

```bash
sudo dnf install edk2-ovmf
```

- When creating the virtual environment, check **customize** before finish
- Change boot type and add '/usr/share/OVMF/UefiShell.iso` disk
- Boot

## Manual way to build your own

### Obtaining the key

Generate Platform Key

PK can be generated by openssh. use the following command to sign your own PK. Note that **PKpriv.key** is the private key and you should preserve it carefully.

```bash
openssl req -newkey rsa:2048 -nodes -keyout PKpriv.key -x509 -days 365 -out PK.crt
openssl x509 -in PK.crt -outform der -out PK.der
```

### Download KEK and DB

You need to download KEK and DB from Microsoft Database:

- [Microsoft Corporation KEK CA 2011](https://go.microsoft.com/fwlink/p/?linkid=321185)
- [Microsoft Windows Production CA 2011](https://go.microsoft.com/fwlink/?LinkId=321192)

### Insert UEFI keys

Make an img file in fat32 form containing the keys

```bash
dd if=/dev/zero of=keys.img bs=4M count=1
mkfs.vfat keys.img
# losetup /dev/loopX keys.img
# mount /dev/loopX /mnt
# cp PK.der /mnt/PK.der
# cp MicCorKEKCA2011_2011-06-24.crt /mnt/KEK.crt
# cp MicWinProPCA2011_2011-10-19.crt /mnt/DB.crt
# umount /dev/loopX
# losetup -d /dev/loopX
```

#### Insert the keys

Start a virtual machine with the img file as a storage device. Enter UEFI configuration menu and Go to secure boot configuration (Device Manager / Secure Boot Configuration / Secure Boot Mode) and change from “Standard Mode” to “Custom Mode”. After change to “Custom Mode”, “Custom Secure Boot Options” will show up, click and enter. PK Options / Enroll PK / Enroll PK Using File and do the same for KEK and DB. ommit Changes and Exit

After import PK, KEK and DB, the secure boot state is now “Enabled”.

## References

- [https://projectacrn.github.io/1.6/tutorials/waag-secure-boot.html](https://projectacrn.github.io/1.6/tutorials/waag-secure-boot.html)
- [https://www.linux.org/threads/create-img-files.11174/](https://www.linux.org/threads/create-img-files.11174/)
- [Windows Secure Boot Key Creation and Management Guidance](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/windows-secure-boot-key-creation-and-management-guidance)
